<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>My Photos</title>
    <link rel="stylesheet" href="assets/css/app.css">
  </head>
  <body>
    <h1 class="title">My Photos</h1>

    <h3 class="title">Rename photos of a folder</h3>
    <!--<form class="form" action="scripts/rename-images.html" method="post">-->
    <form class="form" action="#" method="post">
      <label>
        <input id="photos-folder-txt" type="text" name="photos_folder" placeholder="Photos folder..." />
        <input id="photos-folder" type="file" webkitdirectory />
      </label><br /><br />

      <button class="btn" type="submit">Send!</button>
    </form>

    <hr />
    <section id="files">
      <h4 class="title"></h4>
    </section>

    <footer>
      <!-- All of the Node.js APIs are available in this renderer process. -->
      <p>
        Node.js <script>document.write(process.versions.node)</script> |
        Chromium <script>document.write(process.versions.chrome)</script> |
        Electron <script>document.write(process.versions.electron)</script>
      </p>
      <p>&copy; 2015 - csd</p>
    </footer>
  </body>
  <script>window.$ = window.jQuery = require('jquery');</script>
  <script>

      /**
       * Get taken date
       * @param imgPath string
       * @returns promise
       */
      var ExifImage = require('exif').ExifImage;
      function getTakenDate(imgPath, $container)
      {
          var d = $.Deferred();
          try {
              new ExifImage({image : imgPath}, function (error, exifData) {
                  if (error == null){
                      if(exifData.exif && exifData.exif.DateTimeOriginal){
                          d.resolve({'takenDate': exifData.exif.DateTimeOriginal});
                      }
                  } else {
                      console.log('Error: '+error.message);
                  }
              });
          } catch (error) {
              console.log('Error: ' + error.message);
          }

          return d.promise();
      }

      let fs = require('fs');
      let $pf = $('#photos-folder');
      // let $pft = $('#photos-folder-txt');
      $pf.on('change', (e) => {
          // let pfFiles = $pf[0].files;
          let pfFiles = $pf.prop('files');
          if(pfFiles.length > 0) {
              var selectedFolder = pfFiles[0].path;
              // $pft.val(selectedFolder);
              $('#files .title').text('Folder: ' + selectedFolder);

              let $fileList = $('<ul>');
              fs.readdir(selectedFolder, (err, files) => {
                  console.log(files);
                  if(typeof files != 'undefined' && files && files.length > 0){
                      for (let imgFile of files) {
                          //$fileList.append('<li>'+imgFile+'</li>');
                          let $fileItem = $('<li>');
                          $fileItem.html('<b>'+imgFile+'</b>');

                          fs.stat(selectedFolder + '\\' + imgFile, (err, stats) => {
                              console.log(imgFile, stats);
                              $fileItem.append(' <span class="gray">' + (stats.isFile() ? 'file' : 'dir') + '</span>');
                              getTakenDate(selectedFolder + '\\' + imgFile, $fileItem).then((params) => {
                                  $fileItem.append(' <span class="cyan">' + params.takenDate + '</span>');
                              });
                          });

                          $fileList.append($fileItem);
                      }
                  }

                  $('#files').append($fileList);
              });
          }
      });

//
//        // send event to main window
//        /*const {ipcRenderer} = require('electron');
//        let params = {'folder': pfFiles[0].path};
//        console.log('send event to main window', params);
//        ipcRenderer.send('ri-folder-selected', params);*/
//


         /*fs.readFile('/path/to/countries.json', function(error, data) {
            if (error) {
                console.log(error);
                return;
            }

            var obj = JSON.parse(data);
            for(var p in yourObject) {
                fs.rename('/path/to/' + obj[p] + '.png', '/path/to/' + p + '.png', function(err) {
                    if ( err ) console.log('ERROR: ' + err);
                });
            }
        });*/
//      }
//    });
  </script>
</html>
